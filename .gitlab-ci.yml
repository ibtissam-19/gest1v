# Fichier: .gitlab-ci.yml
# Configuration du pipeline CI/CD pour notre application

stages:
  - build
  - test
  - security
  - package
  - deploy

variables:
  APP_NAME: "gestion_li"
  APP_VERSION: "1.0.0"

############################################
# STAGE 1: BUILD
############################################
build-job:
  stage: build
  image: node:18
  script:
    - echo "Installation des dépendances..."
    - npm install
    - echo "Vérification que le code n'a pas d'erreurs de syntaxe..."
    - node -c app.js
    - node -c appp.js
    - echo "Build terminé avec succès!"
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 hour

############################################
# STAGE 2: TEST
############################################
test-job:
  stage: test
  image: node:18
  script:
    - echo "Exécution des tests unitaires..."
    - npm test
    - echo "Tous les tests sont passés!"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'

############################################
# STAGE 3: SECURITY
############################################
security-secrets-scan:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  script:
    - echo "Recherche de secrets dans le code..."
    - gitleaks detect --source=. --verbose --no-git
    - echo "Aucun secret détecté!"
  allow_failure: false

security-dependencies-scan:
  stage: security
  image: node:18
  script:
    - echo "Vérification des vulnérabilités dans les dépendances..."
    - npm audit --audit-level=high
    - echo "Aucune vulnérabilité critique détectée!"
  allow_failure: false

############################################
# STAGE 4: PACKAGE
############################################
ppackage-docker:
  stage: package
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t $APP_NAME:$APP_VERSION .
    - docker save $APP_NAME:$APP_VERSION > image.tar # This creates the file
  artifacts:
    paths:
      - image.tar # This saves the file for the next stage
  only:
    - main

############################################
# STAGE 5: DEPLOY
############################################
deploy-staging:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker load < image.tar # This brings the image back to life
    - docker stop gestion_li-staging || true
    - docker rm gestion_li-staging || true
    - docker run -d --name gestion_li-staging -p 3000:3000 $APP_NAME:$APP_VERSION
  only:
    - main
deploy-production:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Chargement de l'image depuis l'artéfact..."
    - docker load < image.tar
    - echo "Déploiement en PRODUCTION..."
    - docker stop gestion_li-prod || true
    - docker rm gestion_li-prod || true
    - docker run -d --name gestion_li-prod -p 8080:3000 $APP_NAME:$APP_VERSION
  when: manual
  only:
    - main